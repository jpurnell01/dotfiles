#!/usr/bin/env bash

## Open an aws object details by given id
## currently for mac only
## REQUIRES: aws CLI tool

usage="USAGE: $0 <aws-obj-id>"

if [ $# -ne 1 ]; then
    echo $usage
    exit 1
fi

aws_id=$1; shift

if [[ $aws_id == df-* ]]; then
    obj_detail_url="https://console.aws.amazon.com/datapipeline/home?region=${AWS_DEFAULT_REGION}#ExecutionDetailsPlace:pipelineId=${aws_id}&show=latest"
elif [[ $aws_id == j-* ]]; then
    obj_detail_url="https://console.aws.amazon.com/elasticmapreduce/home?region=${AWS_DEFAULT_REGION}#cluster-details:${aws_id}"
elif [[ $aws_id == i-* ]]; then
    obj_detail_url="https://console.aws.amazon.com/ec2/v2/home?region=${AWS_DEFAULT_REGION}#Instances:search=${aws_id};sort=desc:instanceState"
else
    temp_file=$(mktemp foobar_XXXX)
    aws datapipeline list-pipelines | grep -i -B 1 $pipeline_name > $temp_file
    pipeline_matches=`wc -l < $temp_file | tr -d ' '`

    if [[ $pipeline_matches == 2 ]]; then
        echo "Found one match:"
        aws_id=`head -n 1 $temp_file | grep -o 'df-[[:alnum:]]*'`
        obj_detail_url="https://console.aws.amazon.com/datapipeline/home?region=${AWS_DEFAULT_REGION}#ExecutionDetailsPlace:pipelineId=${aws_id}&show=latest"
        rm ${temp_file}
    else
        echo "Multiple matches returned:"
        awk '/"id":/ {id=substr($2,2,length($2)-3)} /"name":/{print id," => ",substr($2,2,length($2)-2);}' $temp_file
        rm ${temp_file}
        exit 1
    fi
fi

echo "Opening $obj_detail_url in your browser..."
open $obj_detail_url
echo "Done"
